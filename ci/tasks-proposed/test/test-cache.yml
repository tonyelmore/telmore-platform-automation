---
platform: linux

params:
  FAIL_FLAG: false
  SOME_STRING: "this is some default string"
  PIVNET_TOKEN:


caches:
- path: first-directory
- path: downloaded-product
- path: downloaded-stemcell

run:
  path: bash
  args:
  - "-c"
  - |
    cat /var/version && echo ""
    set -eux

    date >> first-directory/first-file

    rm downloaded-product/*.pivotal || true

    echo "output from first-directory/first-file"
    cat first-directory/first-file

    om download-product \
      --pivnet-api-token $PIVNET_TOKEN \
      --pivnet-product-slug p-redis \
      --product-version 3.5.0 \
      --file-glob p-redis-3.5.0-build.1.pivotal \
      --stemcell-iaas vsphere \
      --stemcell-output-directory downloaded-stemcell \
      --output-directory downloaded-product

    ls -al downloaded-product

    ls -al downloaded-stemcell

    echo "String from param is: ${SOME_STRING}"
    if [ $FAIL_FLAG == "true" ]; then
      echo "Making the task fail"
      exit 1
    fi

    echo "Task succeeded"
    exit 0
